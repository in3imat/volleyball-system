<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Player Statistics - Volleyball Management</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">üèê Volleyball Community</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/players-list" class="nav-link">Players List</a>
                <a href="/add-player" class="nav-link">Add Player</a>
                <a href="/add-session" class="nav-link">Add Session</a>
                <a href="/add-player-stats" class="nav-link">Add Player Stats</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="add-player-stats">
            <h1>Add Player Statistics</h1>

            <!-- Success/Error Messages -->
            <div id="messageContainer" style="display: none;" class="alert"></div>

            <!-- Session Selection -->
            <div class="session-selection">
                <h2>Select Session</h2>
                <div class="form-group">
                    <label for="session_id">Session Date *</label>
                    <select id="session_id" name="session_id" required>
                        <option value="">Select a session</option>
                    </select>
                    <small class="form-help">Choose the session you want to add statistics for</small>
                </div>
            </div>

            <!-- Player Statistics Form -->
            <form id="addPlayerStatsForm" class="player-stats-form" style="display: none;">
                <h2>Add Player Statistics for <span id="selectedSessionDate"></span></h2>

                <div class="form-group">
                    <label for="player_id">Player *</label>
                    <select id="player_id" name="player_id" required>
                        <option value="">Select a player</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="form-group">
                        <label for="points_scored">Points Scored</label>
                        <input type="number" id="points_scored" name="points_scored" value="0" min="0">
                    </div>

                    <div class="form-group">
                        <label for="saves">Saves</label>
                        <input type="number" id="saves" name="saves" value="0" min="0">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="mvp_award" name="mvp_award">
                        MVP Award for this session
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Add Player Stats
                    </button>
                    <a href="/add-session" class="btn btn-secondary">Back to Sessions</a>
                </div>
            </form>

            <!-- Session Players Stats -->
            <div id="sessionPlayers" class="session-players" style="display: none;">
                <h2>Players in this Session</h2>
                <div id="playersStatsList" class="players-stats-list">
                    <!-- Player stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base URL for API
        const API_BASE_URL = window.location.origin;

        // Function to fetch data
        async function fetchData(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server returned ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Function to show messages
        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.textContent = message;
            messageContainer.className = `alert alert-${type}`;
            messageContainer.style.display = 'block';
        }

        // Load sessions for dropdown
        async function loadSessions() {
            try {
                const data = await fetchData('/api/sessions');
                const sessionSelect = document.getElementById('session_id');

                if (data && data.sessions && data.sessions.length > 0) {
                    sessionSelect.innerHTML = '<option value="">Select a session</option>' +
                        data.sessions.map(session =>
                            `<option value="${session.id}">${new Date(session.session_date).toLocaleDateString()}</option>`
                        ).join('');
                } else {
                    sessionSelect.innerHTML = '<option value="">No sessions available</option>';
                }

                // Check if session_id is in URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                const sessionDate = urlParams.get('session_date');

                if (sessionId && sessionDate) {
                    sessionSelect.value = sessionId;
                    onSessionChange(sessionId, sessionDate);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Load players for dropdown
        async function loadPlayers() {
            try {
                const data = await fetchData('/api/players-list');
                const playerSelect = document.getElementById('player_id');

                if (data && data.players && data.players.length > 0) {
                    playerSelect.innerHTML = '<option value="">Select a player</option>' +
                        data.players.map(player =>
                            `<option value="${player.id}">${player.full_name} (${player.player_id})</option>`
                        ).join('');
                } else {
                    playerSelect.innerHTML = '<option value="">No players available</option>';
                }
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        // Handle session change
        function onSessionChange(sessionId, sessionDate) {
            const form = document.getElementById('addPlayerStatsForm');
            const sessionPlayers = document.getElementById('sessionPlayers');

            if (sessionId) {
                // Show the form
                form.style.display = 'block';
                sessionPlayers.style.display = 'block';

                // Update selected session date
                if (sessionDate) {
                    document.getElementById('selectedSessionDate').textContent = new Date(sessionDate).toLocaleDateString();
                } else {
                    const sessionSelect = document.getElementById('session_id');
                    const selectedOption = sessionSelect.options[sessionSelect.selectedIndex];
                    document.getElementById('selectedSessionDate').textContent = selectedOption.text;
                }

                // Load players for this session
                loadSessionPlayers(sessionId);
            } else {
                form.style.display = 'none';
                sessionPlayers.style.display = 'none';
            }
        }

        // Load players who have stats for this session
        async function loadSessionPlayers(sessionId) {
            try {
                // This would need a new API endpoint to get players for a specific session
                // For now, we'll just show a message
                const playersStatsList = document.getElementById('playersStatsList');
                playersStatsList.innerHTML = '<div class="no-data">Player statistics for this session will appear here</div>';
            } catch (error) {
                console.error('Error loading session players:', error);
            }
        }

        // Handle form submission
        document.getElementById('addPlayerStatsForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding Stats...';

            const formData = {
                player_id: document.getElementById('player_id').value,
                session_id: document.getElementById('session_id').value,
                points_scored: parseInt(document.getElementById('points_scored').value) || 0,
                saves: parseInt(document.getElementById('saves').value) || 0,
                mvp_award: document.getElementById('mvp_award').checked
            };

            if (!formData.player_id || !formData.session_id) {
                showMessage('Player and Session are required', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            try {
                const result = await fetchData('/api/player-sessions', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (result) {
                    showMessage('Player statistics added successfully!', 'success');

                    // Reset form
                    document.getElementById('addPlayerStatsForm').reset();
                    document.getElementById('points_scored').value = 0;
                    document.getElementById('saves').value = 0;
                    document.getElementById('mvp_award').checked = false;

                    // Reload session players
                    loadSessionPlayers(formData.session_id);
                }
            } catch (error) {
                console.error('Error adding player stats:', error);
                showMessage(`Error adding player statistics: ${error.message}`, 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Event listener for session selection change
        document.getElementById('session_id').addEventListener('change', function () {
            onSessionChange(this.value);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Add Player Stats page loaded');
            loadSessions();
            loadPlayers();
        });
    </script>
</body>

</html>