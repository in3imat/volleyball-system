<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Session - Volleyball Management</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">üèê Volleyball Community</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/players-list" class="nav-link">Players List</a>
                <a href="/add-player" class="nav-link">Add Player</a>
                <a href="/add-session" class="nav-link">Add Session</a>
                <a href="/add-player-stats" class="nav-link">Add Player Stats</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="add-session">
            <h1>Add New Session</h1>

            <!-- Success/Error Messages -->
            <div id="messageContainer" style="display: none;" class="alert"></div>

            <form id="addSessionForm" class="session-form">
                <div class="form-group">
                    <label for="session_date">Session Date *</label>
                    <input type="date" id="session_date" name="session_date" required>
                    <small class="form-help">Select the date when the session/game was played</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Add Session
                    </button>
                    <a href="/" class="btn btn-secondary">Cancel</a>
                </div>
            </form>

            <!-- Existing Sessions -->
            <div class="existing-sessions">
                <h2>Existing Sessions</h2>
                <div id="sessionsList" class="sessions-list">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base URL for API
        const API_BASE_URL = window.location.origin;

        // Function to fetch data
        async function fetchData(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Server returned ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Function to show messages
        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.textContent = message;
            messageContainer.className = `alert alert-${type}`;
            messageContainer.style.display = 'block';

            // Auto hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 3000);
            }
        }

        // Load existing sessions
        async function loadSessions() {
            try {
                const data = await fetchData('/api/sessions');
                const sessionsList = document.getElementById('sessionsList');

                if (data && data.sessions && data.sessions.length > 0) {
                    sessionsList.innerHTML = data.sessions.map(session => `
                        <div class="session-item">
                            <div class="session-date">${new Date(session.session_date).toLocaleDateString()}</div>
                            <div class="session-id">ID: ${session.id}</div>
                            <div class="session-actions">
                                <button onclick="addStatsToSession(${session.id}, '${session.session_date}')" class="btn btn-primary btn-sm">
                                    Add Stats
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    sessionsList.innerHTML = '<div class="no-data">No sessions recorded yet</div>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionsList').innerHTML = '<div class="no-data">Error loading sessions</div>';
            }
        }

        // Redirect to add player stats for a specific session
        function addStatsToSession(sessionId, sessionDate) {
            window.location.href = `/add-player-stats?session_id=${sessionId}&session_date=${sessionDate}`;
        }

        // Set today's date as default
        document.getElementById('session_date').valueAsDate = new Date();

        // Handle form submission
        document.getElementById('addSessionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding Session...';

            const formData = {
                session_date: document.getElementById('session_date').value
            };

            if (!formData.session_date) {
                showMessage('Session date is required', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }

            try {
                const result = await fetchData('/api/sessions', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (result) {
                    showMessage('Session added successfully!', 'success');

                    // Reset form
                    document.getElementById('addSessionForm').reset();
                    document.getElementById('session_date').valueAsDate = new Date();

                    // Reload sessions list
                    loadSessions();
                }
            } catch (error) {
                console.error('Error adding session:', error);
                showMessage(`Error adding session: ${error.message}`, 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Add Session page loaded');
            loadSessions();
        });
    </script>
</body>

</html>