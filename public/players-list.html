<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Players List - Volleyball Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">Volleyball Community</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/players-list" class="nav-link active">Players List</a>
                <a href="/add-player" class="nav-link">Add Player</a>
                <a href="/add-session" class="nav-link">Add Session</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="players-list-page">
            <div class="page-header">
                <h1>Players List</h1>
                <a href="/add-player" class="btn btn-primary">Add New Player</a>
            </div>

            <!-- Health Status -->
            <div id="healthStatus" class="alert" style="display: none; margin-bottom: 1rem;"></div>

            <div class="search-section">
                <input type="text" id="searchInput" placeholder="Search players by name, ID, or Instagram..." class="search-input">
            </div>

            <div class="players-table-container">
                <table class="players-table">
                    <thead>
                        <tr>
                            <th>Player ID</th>
                            <th>Full Name</th>
                            <th>Phone Number</th>
                            <th>Instagram</th>
                            <th>Age</th>
                            <th>Skill Level</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <!-- Players will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="loadingMessage" class="loading">Loading players...</div>
            <div id="noPlayersMessage" class="no-data" style="display: none;">
                <p>No players found in the system.</p>
                <p><a href="/add-player" class="btn btn-primary">Add Your First Player</a></p>
            </div>
            <div id="errorMessage" class="no-data" style="display: none;">
                <p>Unable to load players. Please check if the server is running.</p>
                <p><a href="javascript:location.reload()" class="btn btn-secondary">Retry</a></p>
            </div>
        </div>
    </div>

    <script>
        // Base URL for API
        const API_BASE_URL = window.location.origin;

        // Function to fetch data
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        let allPlayers = [];

        // Check server health
        async function checkServerHealth() {
            try {
                const response = await fetchData('/api/health');
                if (response && response.status === 'OK') {
                    showHealthStatus('✅ Server is running properly', 'alert-success');
                    return true;
                }
            } catch (error) {
                console.error('Health check failed:', error);
                showHealthStatus('❌ Cannot connect to server. Please make sure the server is running.', 'alert-error');
                return false;
            }
        }

        function showHealthStatus(message, type) {
            const healthStatus = document.getElementById('healthStatus');
            healthStatus.textContent = message;
            healthStatus.className = `alert ${type}`;
            healthStatus.style.display = 'block';
        }

        // Load players list
        async function loadPlayersList() {
            const loadingMessage = document.getElementById('loadingMessage');
            const noPlayersMessage = document.getElementById('noPlayersMessage');
            const errorMessage = document.getElementById('errorMessage');
            const tableBody = document.getElementById('playersTableBody');

            // Hide all messages initially
            loadingMessage.style.display = 'block';
            noPlayersMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            tableBody.innerHTML = '';

            try {
                console.log('Fetching players from /api/players-list...');
                const data = await fetchData('/api/players-list');
                
                if (!data) {
                    throw new Error('No data received from server');
                }
                
                allPlayers = data.players || [];
                displayPlayers(allPlayers);
                
                loadingMessage.style.display = 'none';
                
                if (allPlayers.length === 0) {
                    noPlayersMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading players:', error);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.innerHTML = `
                    <p><strong>Error loading players:</strong> ${error.message}</p>
                    <p>Please ensure:</p>
                    <ul>
                        <li>Server is running properly</li>
                        <li>Database is accessible</li>
                        <li>No firewall is blocking the connection</li>
                    </ul>
                    <p><a href="javascript:location.reload()" class="btn btn-secondary">Retry</a></p>
                `;
            }
        }

        // Display players in table
        function displayPlayers(players) {
            const tableBody = document.getElementById('playersTableBody');
            const noPlayersMessage = document.getElementById('noPlayersMessage');
            const errorMessage = document.getElementById('errorMessage');

            // Hide messages
            noPlayersMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            if (players.length === 0) {
                tableBody.innerHTML = '';
                return;
            }

            tableBody.innerHTML = players.map(player => `
                <tr>
                    <td><strong>${player.player_id}</strong></td>
                    <td>${player.full_name}</td>
                    <td>${player.phone_number || '-'}</td>
                    <td>${player.instagram_username ? '@' + player.instagram_username : '-'}</td>
                    <td>${player.age || '-'}</td>
                    <td>
                        <span class="skill-badge ${player.skill_level.toLowerCase()}">
                            ${player.skill_level}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editPlayer(${player.id})" class="btn btn-secondary btn-sm">
                                Edit
                            </button>
                            <button onclick="viewPlayerStats(${player.id})" class="btn btn-primary btn-sm">
                                Stats
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPlayers = allPlayers.filter(player => 
                    player.full_name.toLowerCase().includes(searchTerm) ||
                    player.player_id.toLowerCase().includes(searchTerm) ||
                    (player.instagram_username && player.instagram_username.toLowerCase().includes(searchTerm)) ||
                    (player.phone_number && player.phone_number.includes(searchTerm))
                );
                displayPlayers(filteredPlayers);
                
                // Show no results message if no matches
                const noPlayersMessage = document.getElementById('noPlayersMessage');
                if (filteredPlayers.length === 0 && searchTerm !== '') {
                    noPlayersMessage.style.display = 'block';
                    noPlayersMessage.innerHTML = `<p>No players found matching "${searchTerm}"</p>`;
                } else {
                    noPlayersMessage.style.display = 'none';
                }
            });
        }

        // Edit player
        function editPlayer(playerId) {
            window.location.href = `/edit-player?id=${playerId}`;
        }

        // View player statistics
        function viewPlayerStats(playerId) {
            alert(`View player stats for ID: ${playerId}\nThis feature will show detailed statistics.`);
            // You can implement this later: window.location.href = `/player-stats.html?id=${playerId}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Players List page loaded');
            
            // First check server health
            const isHealthy = await checkServerHealth();
            
            if (isHealthy) {
                // Then load players
                await loadPlayersList();
                setupSearch();
            } else {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        });
    </script>
</body>
</html>